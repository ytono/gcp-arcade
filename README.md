このドキュメントは、オープンソースのシングルサインオン (SSO) ソリューションである Keycloak (バージョン 16.0.0 から 25.0) の機能と主要な概念について詳細に説明しています。

**Keycloak の概要**

Keycloak は、Web アプリケーションと RESTful Web サービス向けの SSO ソリューションで、アプリケーション開発者が組織内でデプロイされたアプリケーションやサービスを簡単に保護できるようにすることを目指しています。通常、開発者が自身で記述する必要があるセキュリティ機能が標準で提供されており、組織の個別の要件に合わせて簡単に調整できます。

**Keycloak の機能**

Keycloak は、以下の機能を提供しています。

* **ブラウザアプリケーション向けのシングルサインオンとシングルサインアウト**
* **OpenID Connect サポート**
* **OAuth 2.0 サポート**
* **SAML サポート**
* **アイデンティティブローカー - 外部の OpenID Connect または SAML アイデンティティプロバイダーによる認証**
* **ソーシャルログイン - Google、GitHub、Facebook、Twitter などのソーシャルネットワークによるログインを有効化**
* **ユーザーフェデレーション - LDAP および Active Directory サーバーからのユーザー同期**
* **Kerberos ブリッジ - Kerberos サーバーにログインしているユーザーを自動的に認証**
* **管理コンソール - ユーザー、ロール、ロールマッピング、クライアント、構成の一元管理**
* **アカウントコンソール - ユーザーが自分のアカウントを一元管理できるようにする**
* **テーマサポート - ユーザー向けページをすべてカスタマイズして、アプリケーションやブランディングと統合**
* **二要素認証 - Google Authenticator または FreeOTP を介した TOTP/HOTP のサポート**
* **ログインフロー - オプションのユーザーセルフ登録、パスワードの回復、メールの確認、パスワードの更新の要求など**
* **セッション管理 - 管理者とユーザー自身がユーザーセッションを表示および管理できる**
* **トークンマッパー - ユーザー属性、ロールなどをトークンやステートメントにマッピング**
* **レルム、アプリケーション、ユーザーごとの失効ポリシー**
* **CORS サポート - クライアントアダプターは CORS のサポートを組み込んでいる**
* **サービスプロバイダーインターフェース (SPI) - サーバーのさまざまな側面をカスタマイズできるようにするための多数の SPI。認証フロー、ユーザーフェデレーションプロバイダー、プロトコルマッパーなど**
* **OpenID Connect リライングパーティライブラリまたは SAML 2.0 サービスプロバイダーライブラリを持つ任意のプラットフォーム/言語をサポート**

**Keycloak の基本操作**

Keycloak は、ネットワーク上で管理する独立したサーバーです。アプリケーションは、このサーバーを指し示し、このサーバーによって保護されるように構成されます。Keycloak は、OpenID Connect や SAML 2.0 などのオープンなプロトコル標準を使用してアプリケーションを保護します。ブラウザアプリケーションは、ユーザーのブラウザをアプリケーションから Keycloak 認証サーバーにリダイレクトし、そこでユーザーは資格情報を入力します。このリダイレクトは、ユーザーがアプリケーションから完全に隔離され、アプリケーションがユーザーの資格情報を決して見ることがないため、重要です。代わりに、アプリケーションには暗号化署名されたアイデンティティトークンまたはアサーションが与えられます。これらのトークンには、ユーザー名、住所、メールアドレス、その他のプロファイルデータなどのアイデンティティ情報を含めることができます。また、アプリケーションが承認の決定を下せるように、許可データを含めることもできます。これらのトークンは、REST ベースのサービスを安全に呼び出すためにも使用できます。

**主要な概念と用語**

Keycloak を使用して Web アプリケーションと REST サービスを保護する前に、以下の主要な概念と用語を考慮してください。

* **ユーザー**: システムにログインできるエンティティ。メール、ユーザー名、住所、電話番号、誕生日などの属性を関連付けることができます。グループメンバーシップを割り当て、特定のロールを割り当てることができます。
* **認証**: ユーザーを識別および検証するプロセス。
* **承認**: ユーザーにアクセス権を付与するプロセス。
* **資格情報**: Keycloak がユーザーのアイデンティティを検証するために使用するデータ。パスワード、ワンタイムパスワード、デジタル証明書、指紋などがあります。
* **ロール**: ユーザーのタイプまたはカテゴリを識別します。管理者、ユーザー、マネージャー、従業員はすべて、組織内に存在する可能性のある典型的なロールです。アプリケーションは、多くの場合、個々のユーザーを扱うのは粒度が細かすぎて管理が難しいため、個々のユーザーではなく、特定のロールにアクセス権と許可を割り当てます。
* **ユーザーロールマッピング**: ロールとユーザー間のマッピングを定義します。ユーザーはゼロ以上のロールに関連付けることができます。このロールマッピング情報は、トークンとアサーションにカプセル化して、アプリケーションが管理するさまざまなリソースへのアクセス許可を決定できるようにすることができます。
* **複合ロール**: 他のロールに関連付けることができるロール。たとえば、スーパーユーザー複合ロールは、販売管理者ロールと注文入力管理者ロールに関連付けることができます。ユーザーがスーパーユーザーロールにマッピングされている場合、販売管理者ロールと注文入力管理者ロールも継承します。
* **グループ**: ユーザーのグループを管理します。グループには属性を定義できます。ロールをグループにマッピングすることもできます。グループのメンバーになったユーザーは、そのグループが定義する属性とロールマッピングを継承します。
* **レルム**: ユーザー、資格情報、ロール、グループのセットを管理します。ユーザーはレルムに属し、レルムにログインします。レルムは互いに隔離されており、制御するユーザーのみを管理および認証できます。
* **クライアント**: Keycloak にユーザーの認証を要求できるエンティティ。ほとんどの場合、クライアントは、Keycloak を使用して自身を保護し、シングルサインオンソリューションを提供したいアプリケーションやサービスです。クライアントは、アイデンティティ情報またはアクセストークンを要求したいだけのエンティティである場合もあります。これにより、Keycloak によって保護されているネットワーク上の他のサービスを安全に呼び出すことができます。
* **クライアントアダプター**: Keycloak と通信し、Keycloak によって保護されるようにアプリケーション環境にインストールするプラグイン。Keycloak には、ダウンロードできるさまざまなプラットフォーム用のアダプターがいくつかあります。また、対象外の環境向けに取得できるサードパーティ製のアダプターもあります。
* **同意**: 管理者として、クライアントが認証プロセスに参加する前に、ユーザーにクライアントへの許可を与えたい場合。ユーザーが資格情報を入力すると、Keycloak はログインを要求しているクライアントとユーザーに要求されているアイデンティティ情報を識別する画面を表示します。ユーザーはリクエストを許可するかどうかを決定できます。
* **クライアントスコープ**: クライアントを登録するときは、そのクライアントのプロトコルマッパーとロールスコープマッピングを定義する必要があります。クライアントスコープを保存して、いくつかの共通設定を共有することで、新しいクライアントの作成を容易にすることがよくあります。これは、スコープパラメーターの値に基づいて、一部のクレームまたはロールを条件付きで要求する場合にも役立ちます。Keycloak は、このためのクライアントスコープの概念を提供しています。
* **クライアントロール**: クライアントは、クライアントに固有のロールを定義できます。これは基本的に、クライアント専用のロール名前空間です。
* **アイデンティティトークン**: ユーザーに関するアイデンティティ情報を提供するトークン。OpenID Connect 仕様の一部。
* **アクセストークン**: 呼び出されているサービスへのアクセスを許可する HTTP リクエストの一部として提供できるトークン。これは、OpenID Connect および OAuth 2.0 仕様の一部です。
* **アサーション**: ユーザーに関する情報。これは通常、認証されたユーザーに関するアイデンティティメタデータを提供する SAML 認証応答に含まれる XML blob に関連します。
* **サービスアカウント**: 各クライアントには、アクセストークンを取得できる組み込みのサービスアカウントがあります。
* **ダイレクトグラント**: クライアントが REST 呼び出しを介してユーザーに代わってアクセストークンを取得する方法。
* **プロトコルマッパー**: クライアントごとに、OIDC トークンまたは SAML アサーションに保存されるクレームとアサーションを調整できます。これは、クライアントごとにプロトコルマッパーを作成および構成することで行います。
* **セッション**: ユーザーがログインすると、ログインセッションを管理するためのセッションが作成されます。セッションには、ユーザーがいつログインしたか、そのセッション中にシングルサインオンに参加したアプリケーションなど、情報が含まれています。管理者とユーザーの両方がセッション情報を表示できます。
* **ユーザーフェデレーションプロバイダー**: Keycloak はユーザーを保存および管理できます。多くの場合、企業にはすでにユーザーと資格情報を保存する LDAP または Active Directory サービスがあります。Keycloak をポイントして、これらの外部ストアからの資格情報を検証し、アイデンティティ情報を取得することができます。
* **アイデンティティプロバイダー**: アイデンティティプロバイダー (IDP) は、ユーザーを認証できるサービスです。Keycloak は IDP です。
* **アイデンティティプロバイダーフェデレーション**: Keycloak は、1 つ以上の IDP に認証を委任するように構成できます。Facebook または Google+ を介したソーシャルログインは、アイデンティティプロバイダーフェデレーションの例です。また、Keycloak をフックして、他の OpenID Connect または SAML 2.0 IDP に認証を委任することもできます。
* **アイデンティティプロバイダーマッパー**: IDP フェデレーションを実行する場合、着信トークンとアサーションをユーザー属性とセッション属性にマッピングできます。これにより、外部 IDP から認証を要求しているクライアントにアイデンティティ情報を伝播できます。
* **必須アクション**: ユーザーが認証プロセス中に実行する必要があるアクション。ユーザーは、これらのアクションが完了するまで認証プロセスを完了できません。たとえば、管理者はユーザーに毎月パスワードをリセットするようにスケジュールを設定する場合があります。これらのすべてのユーザーにパスワードの更新が必要なアクションが設定されます。
* **認証フロー**: ユーザーがシステムの特定の側面と対話するときに実行する必要があるワークフロー。ログインフローは、必要な資格情報のタイプを定義できます。登録フローは、ユーザーが入力する必要があるプロファイル情報と、ボットをフィルタリングするために reCAPTCHA のようなものを使用する必要があるかどうかを定義します。資格情報リセットフローは、ユーザーがパスワードをリセットする前に実行する必要があるアクションを定義します。
* **イベント**: 管理者が表示およびフックできる監査ストリーム。
* **テーマ**: Keycloak によって提供されるすべての画面は、テーマによってサポートされています。テーマは HTML テンプレートとスタイルシートを定義し、必要に応じてオーバーライドできます。

このドキュメントでは、最初の管理者の作成、レルムの構成、ユーザーの管理、認証の構成、アイデンティティプロバイダーの統合、Admin CLI の使用など、Keycloak のさまざまな側面について詳しく説明しています。

このドキュメントは、Keycloak を使い始めるのに役立つ包括的なガイドを提供します。

このドキュメントは、オープンソースのシングルサインオンソリューションである Keycloak の機能と基本的な操作について説明しています。

**Keycloak の特徴**

Keycloak は、ブラウザアプリケーションと RESTful Web サービス向けの包括的なシングルサインオンソリューションであり、アプリケーション開発者にとってセキュリティ対策を容易にすることを目的としています。

主な機能は以下の通りです。

* ブラウザアプリケーション向けシングルサインオンとシングルサインアウト
* OpenID Connect、OAuth 2.0、SAML のサポート
* 外部 OpenID Connect または SAML ID プロバイダーによる認証 (アイデンティティブローカー)
* Google、GitHub、Facebook、Twitter などのソーシャルネットワークによるログイン (ソーシャルログイン)
* LDAP および Active Directory サーバーからのユーザー同期 (ユーザーフェデレーション)
* Kerberos サーバーにログインしているユーザーを自動的に認証 (Kerberos ブリッジ)
* ユーザー、ロール、ロールマッピング、クライアント、設定を一元管理するための管理コンソール
* ユーザーが自分のアカウントを一元管理できるアカウントコンソール
* アプリケーションとブランドに合わせてユーザー向けページをカスタマイズできるテーマサポート
* Google Authenticator または FreeOTP を使用した TOTP/HOTP のサポート (2段階認証)
* オプションのユーザーセルフ登録、パスワード回復、メール確認、パスワード更新の要求などを含むログインフロー
* 管理者とユーザー自身がユーザーセッションの表示と管理ができるセッション管理
* ユーザー属性、ロールなどをトークンやステートメントにマッピングするトークンマッパー
* レルム、アプリケーション、ユーザーごとの「有効期間開始」失効ポリシー
* CORS サポート - クライアントアダプターには CORS のサポートが組み込まれている
* サーバーのさまざまな側面をカスタマイズできるサービスプロバイダーインターフェース (SPI)。認証フロー、ユーザーフェデレーションプロバイダー、プロトコルマッパーなど
* OpenID Connect リライングパーティライブラリまたは SAML 2.0 サービスプロバイダーライブラリを持つ任意のプラットフォーム/言語をサポート

**Keycloak の基本的な操作**

Keycloak は、ネットワーク上で管理する独立したサーバーです。アプリケーションは、このサーバーをポイントするように設定され、セキュリティ保護されます。Keycloak は、OpenID Connect や SAML 2.0 などのオープンなプロトコル標準を使用してアプリケーションを保護します。ブラウザアプリケーションは、ユーザーのブラウザをアプリケーションから Keycloak 認証サーバーにリダイレクトし、そこでユーザーは資格情報を入力します。このリダイレクトは、ユーザーがアプリケーションから完全に隔離され、アプリケーションがユーザーの資格情報を決して見ることがないため、重要です。代わりに、アプリケーションには暗号で署名された ID トークンまたはアサーションが提供されます。これらのトークンには、ユーザー名、住所、メールアドレス、その他のプロファイルデータなどの ID 情報を含めることができます。また、アプリケーションが承認の決定を下せるように、許可データを含めることもできます。これらのトークンは、REST ベースのサービスに対して安全な呼び出しを行うためにも使用できます。

**最初の管理者の作成**

Keycloak のインストール後、Keycloak を管理するための完全な権限を持つスーパー管理者として機能できる管理者アカウントが必要です。このアカウントを使用して、Keycloak 管理コンソールにログインし、レルムとユーザーを作成し、Keycloak によって保護されているアプリケーションを登録できます。

**ローカルホストでのアカウントの作成**

サーバーが localhost からアクセスできる場合は、以下の手順を実行します。

1. Web ブラウザで、http://localhost:8080 URL にアクセスします。
2. 思い出せるユーザー名とパスワードを入力します。

**リモートでのアカウントの作成**

localhost アドレスからサーバーにアクセスできない場合、またはコマンドラインから Keycloak を起動したい場合は、KEYCLOAK_ADMIN および KEYCLOAK_ADMIN_PASSWORD 環境変数を使用して、初期管理者アカウントを作成します。

例:

```
export KEYCLOAK_ADMIN=<username>
export KEYCLOAK_ADMIN_PASSWORD=<password>

bin/kc.[sh|bat] start
```

**レルムの設定**

管理コンソールの管理者アカウントを取得したら、レルムを設定できます。レルムは、ユーザー、アプリケーション、ロール、グループを含むオブジェクトを管理するスペースです。ユーザーはレルムに属し、レルムにログインします。1 つの Keycloak デプロイメントでは、データベースにスペースがある限り、多くのレルムを定義、保存、管理できます。

**管理コンソールの使用**

レルムの設定やほとんどの管理タスクは、Keycloak 管理コンソールで行います。

前提条件: 管理者アカウントが必要です。最初の管理者の作成を参照してください。

手順:

1. 管理コンソールの URL にアクセスします。
例: localhost の場合は、次の URL を使用します。http://localhost:8080/admin/
2. ウェルカムページまたは環境変数を使用して作成したユーザー名とパスワードを入力します。この操作により、管理コンソールが表示されます。

**マスターレルム**

管理コンソールには、2 種類のレルムが存在します。

* マスターレルム - このレルムは、Keycloak を最初に起動したときに作成されたものです。最初のログイン時に作成した管理者アカウントが含まれています。マスターレルムは、システム内のレルムを作成および管理するためにのみ使用します。
* 他のレルム - これらのレルムは、マスターレルムの管理者によって作成されます。これらのレルムでは、管理者は組織内のユーザーと必要なアプリケーションを管理します。アプリケーションはユーザーが所有します。

レルムは互いに隔離されており、制御するユーザーのみを管理および認証できます。このセキュリティモデルに従うことで、誤った変更を防ぎ、ユーザーアカウントに現在のタスクを正常に完了するために必要な権限と権限のみへのアクセスを許可するという伝統に従います。

**レルムの作成**

ユーザーを作成し、アプリケーションを使用する権限を与えるための管理スペースを提供するために、レルムを作成します。最初のログイン時には、通常はマスターレルムにいます。マスターレルムは、他のレルムを作成するためのトップレベルのレルムです。

必要なレルムを決定する際には、ユーザーとアプリケーションにどのような分離が必要かを考慮してください。たとえば、会社の従業員用のレルムと、顧客用の別のレルムを作成する場合があります。従業員は従業員レルムにログインし、社内アプリケーションのみにアクセスできます。顧客は顧客レルムにログインし、顧客向けアプリとのみやり取りできます。

手順:

1. マスターレルムの横にある Keycloak をクリックし、[レルムの作成] をクリックします。
2. レルムの名前を入力します。
3. [作成] をクリックします。

これで、現在のレルムは作成したレルムに設定されます。メニューのレルム名をクリックすることで、レルムを切り替えることができます。

**外部ストレージの使用**

組織には、情報、パスワード、その他の資格情報を含むデータベースがある場合があります。通常、既存のデータストレージを Keycloak デプロイメントに移行することはできないため、Keycloak は既存の外部ユーザーデータベースをフェデレートできます。Keycloak は LDAP と Active Directory をサポートしていますが、Keycloak User Storage SPI を使用して、カスタムユーザーデータベースの拡張機能をコーディングすることもできます。

ユーザーがログインしようとすると、Keycloak はそのユーザーのストレージを調べてそのユーザーを見つけます。Keycloak がユーザーを見つけられない場合、Keycloak は一致するまでレルムの各 User Storage プロバイダーを反復処理します。外部データストレージからのデータは、Keycloak ランタイムが消費する標準ユーザーモデルにマッピングされます。このユーザーモデルは、OIDC トークン要求と SAML アサーション属性にマッピングされます。

外部ユーザーデータベースには、Keycloak のすべての機能をサポートするために必要なデータがほとんどないため、User Storage プロバイダーは Keycloak ユーザーデータストレージにアイテムをローカルに保存することを選択できます。プロバイダーはユーザーをローカルにインポートし、定期的に外部データストレージと同期できます。このアプローチは、プロバイダーの機能とプロバイダーの構成によって異なります。たとえば、外部ユーザーデータストレージが OTP をサポートしていない場合があります。プロバイダーによっては、OTP を Keycloak で処理して保存できます。


## Managing Users と Managing User Sessions の概要 (Keycloak バージョン 16.0.0-25.0)

添付ファイルの "Managing users" と "Managing user sessions" は、Keycloak におけるユーザーとセッション管理機能の概要を説明しています。以下は、それぞれのセクションの重要なポイントをまとめたものです。

**Managing Users**

* **ユーザーの作成と管理**: Keycloak では、ユーザーを作成し、属性（メールアドレス、名前、住所など）を管理できます。ユーザーは、グループに所属し、特定のロールを割り当てることができます。
* **ユーザー属性の管理**: Keycloak はユーザー属性を管理するためのスキーマを提供しており、管理者は属性を必須にするかどうか、属性の表示/編集権限、検証ルール、UI アノテーションなどを定義できます。
* **ユーザー資格情報の定義**: Keycloak では、パスワード、ワンタイムパスワード (OTP)、デジタル証明書、指紋などの資格情報を管理できます。管理者は、ユーザーのパスワードをリセットしたり、OTP の設定を要求したりできます。
* **ユーザーのセルフ登録**: 管理者は、ユーザーがセルフ登録できるように Keycloak を設定できます。セルフ登録が有効になっている場合、ログインページに登録リンクが表示されます。
* **ログイン時に必要なアクション**: 管理者は、ユーザーが最初にログインする際に実行する必要があるアクションを設定できます。これらのアクションには、パスワードの更新、OTP の設定、メールアドレスの確認、プロファイルの更新などがあります。
* **reCAPTCHA の有効化**: ボットによる登録を防ぐため、Keycloak には Google reCAPTCHA の統合機能があります。管理者は、reCAPTCHA を有効にすることで、登録プロセス中にユーザーに reCAPTCHA チャレンジを提示できます。
* **ユーザーの検索**: 管理者は、ユーザーのフルネーム、姓、名、またはメールアドレスを使用してユーザーを検索できます。
* **ユーザーの削除**: 管理者は、ユーザーを削除できます。ユーザーが削除されると、そのユーザーのプロファイルとデータも削除されます。
* **ユーザーのなりすまし**: 管理者は、適切な権限を持つユーザーになりすますことができます。
* **ロールとグループを使用した権限の割り当て**: Keycloak では、ロールとグループを使用してユーザーに権限を割り当てることができます。ロールは、ユーザーのタイプを識別し、アプリケーションはロールにアクセス許可を割り当てます。グループは、ユーザーのグループを管理し、ロールと属性をグループに適用できます。

**Managing User Sessions**

* **ユーザーセッションの管理**: ユーザーがレルムにログインすると、Keycloak は各ユーザーのユーザーセッションを維持し、セッション内でユーザーがアクセスした各クライアントを記憶します。レルム管理者は、各ユーザーセッションに対して、ログイン統計の表示、アクティブユーザーとログイン場所の表示、ユーザーのログアウト、トークンの失効、トークンのタイムアウト設定、セッションのタイムアウト設定など、さまざまなアクションを実行できます。
* **セッションの管理**: 管理者は、アクティブなクライアントとセッションの概要を表示したり、レルム内のすべてのユーザーをログアウトしたり、クライアントセッションとユーザーセッションを表示したり、アクティブなセッションを失効させたりできます。
* **セッションとトークンのタイムアウト**: Keycloak には、レルム設定メニューの [セッション] タブと [トークン] タブで、セッション、Cookie、およびトークンのタイムアウトを制御する機能があります。管理者は、SSO セッションのアイドルタイムアウト、SSO セッションの最大時間、クライアントセッションのアイドルタイムアウト、クライアントセッションの最大時間などを設定できます。
* **オフラインアクセス**: Keycloak は、オフラインアクセスのログインをサポートしています。オフラインアクセスのログインでは、クライアントアプリケーションはリフレッシュトークンの代わりにオフライントークンを要求します。クライアントアプリケーションは、このオフライントークンを保存し、ユーザーがログアウトした場合でも、将来のログインにこのトークンを使用できます。
* **一時セッション**: Keycloak では、一時セッションを実行できます。一時セッションを使用する場合、Keycloak は認証が成功した後もユーザーセッションを作成しません。Keycloak は、ユーザーを正常に認証した現在のリクエストのスコープに対して、一時的な一時セッションを作成します。

これらの機能を使用することで、Keycloak 管理者は、ユーザーとセッションを効率的に管理し、アプリケーションのセキュリティを強化できます。


このドキュメントは、Keycloakバージョン16.0.0から25.0までの機能と概念、基本的な操作について解説しています。特に、**ロールとグループを使用した権限の割り当て**と**認証の設定**の概要について説明します。

### ロールとグループを使用した権限の割り当て

Keycloakは、ロールとグループを使用して、ユーザーにアプリケーションへのアクセスと権限を付与します。

* **ロール**: 特定のアプリケーション権限とアクセス制御を定義します。例として、管理者、ユーザー、マネージャー、従業員などのロールがあります。アプリケーションは、個々のユーザーではなく、特定のロールにアクセスと権限を割り当てることが一般的です。
* **グループ**: ユーザーのグループを管理します。グループには属性を定義したり、ロールをマッピングしたりできます。グループのメンバーになったユーザーは、そのグループで定義されている属性とロールマッピングを継承します。
* **コンポジットロール**: 他のロールに関連付けることができるロールです。例として、スーパーユーザーのコンポジットロールは、販売管理者ロールと注文入力管理者ロールに関連付けることができます。ユーザーがスーパーユーザーロールにマッピングされると、販売管理者ロールと注文入力管理者ロールも継承します。

Keycloakでは、**レルムロール**と**クライアントロール**の2種類のロールを使用できます。

* レルムロールは、レルム全体に適用されるグローバルなロールです。
* クライアントロールは、特定のクライアント（アプリケーション）にのみ適用されるロールです。

ユーザーにロールを割り当てるには、ユーザーの詳細ページの**ロールマッピング**タブを使用します。グループにロールを割り当てるには、グループの詳細ページの**ロールマッピング**タブを使用します。

### 認証の設定

Keycloakは、さまざまな認証メカニズムをサポートしています。これらのメカニズムは、**認証フロー**と呼ばれるワークフローに編成されています。

* **パスワードポリシー**: Keycloakでは、パスワードの複雑さ、有効期限、履歴などのパスワードポリシーを設定できます。これにより、強力なパスワードの使用を強制できます。
* **ワンタイムパスワード（OTP）ポリシー**: Keycloakは、Google AuthenticatorなどのOTPジェネレーターを使用した2要素認証をサポートしています。
* **認証フロー**: Keycloakには、ログイン、登録、資格情報の再設定など、さまざまな認証フローが組み込まれています。これらのフローは、必要に応じてカスタマイズできます。
* **Kerberos**: Keycloakは、SPNEGOプロトコルを介したKerberosチケットによるログインをサポートしています。これにより、ユーザーはデスクトップにログインした後に、Keycloakで保護されたWebアプリケーションに透過的にアクセスできます。
* **X.509クライアント証明書**: Keycloakは、相互SSL認証を使用するようにサーバーが設定されている場合、X.509クライアント証明書によるログインをサポートしています。
* **WebAuthn**: Keycloakは、WebAuthn（パスワードレス認証と2要素認証）をサポートしています。

認証フローは、**認証**、**画面**、**アクション**のコンテナです。認証は、ユーザーを認証するためのメカニズムです（例: ユーザー名/パスワードフォーム、OTPフォーム）。画面は、ユーザーに情報を表示したり、入力を求めたりするためのものです。アクションは、認証プロセス中に実行されるタスクです（例: リセットメールの送信、OTPの検証）。

認証フローは、必要に応じてカスタマイズできます。たとえば、パスワードレスログインフローを作成したり、ステップアップ認証メカニズムを使用して、ユーザーの特定の認証レベルに基づいてクライアントまたはリソースへのアクセスを許可したりできます。

このドキュメントでは、Keycloakの基本的な概念と用語、レルムの設定、ユーザーの管理、認証の設定など、Keycloakの基本的な操作について説明しています。Keycloakの詳細については、サーバー開発者ガイドを参照してください。


このドキュメントは Keycloak の機能、用語、管理方法について解説したものです。添付ファイルの概要を3つのセクションに分けて説明します。

## 1. Integrating identity providers (ID プロバイダーの統合)

Keycloak は、Facebook、Google などの外部 ID プロバイダーと連携し、認証を委任することができます。これを**ID プロバイダー連携**と呼びます。

**Keycloak が ID ブローカーとして機能する場合の流れ：**

1. ユーザーはクライアントアプリケーションで保護されたリソースにアクセスしようとします。
2. クライアントアプリケーションは、ユーザーを Keycloak にリダイレクトして認証を行います。
3. Keycloak は、レルムで設定された ID プロバイダーのリストを表示します。
4. ユーザーは、リストから ID プロバイダーを選択し、そのログインページにリダイレクトされます。
5. ユーザーは、ID プロバイダーに資格情報を入力し認証を行います。
6. 認証が成功すると、ID プロバイダーは Keycloak に認証レスポンスを返します。
7. Keycloak はレスポンスを検証し、ユーザーが Keycloak に存在しない場合は、ユーザー情報を取り込み新規アカウントを作成します (**アイデンティティ連携**)。既存ユーザーの場合は、ID プロバイダーから返されたアイデンティティを既存アカウントにリンクするように求められます (**アカウントリンク**)。
8. Keycloak は、ユーザーを認証し、サービスプロバイダーのリソースにアクセスするためのトークンを発行します。
9. ユーザーはサービスプロバイダーにリダイレクトされ、保護されたリソースにアクセスできます。

**設定可能な項目:**

* **エイリアス:** ID プロバイダーを一意に識別するための名前。
* **有効:** プロバイダーを有効にするかどうか。
* **ログインページに表示:** ログインページにプロバイダーを表示するかどうか。
* **アカウントリンクのみ:** 既存アカウントとのリンクのみを許可するかどうか。
* **トークンの保存:** ID プロバイダーからのトークンを保存するかどうか。
* **保存されたトークンを読み取り可能にする:** ユーザーが保存された ID プロバイダーのトークンを取得できるようにするかどうか。
* **メールを信頼する:** ID プロバイダーからのメールアドレスを信頼するかどうか。
* **GUI の順序:** ログインページに表示される ID プロバイダーの順序。
* **最初のログインフロー:** ユーザーが初めて ID プロバイダーを使用してログインする際に実行される認証フロー。

## 2. SSO protocols (SSO プロトコル)

Keycloak は、OpenID Connect (OIDC) と SAML 2.0 の2つの SSO プロトコルをサポートしています。

### 2.1 OpenID Connect (OIDC)

OIDC は、OAuth 2.0 を拡張した認証プロトコルで、JSON Web Token (JWT) 標準を使用します。

**主なユースケース:**

1. アプリケーションが Keycloak サーバーにユーザーの認証を要求する。
2. クライアントがリモートサービスにアクセスする。

**OIDC 認証フロー:**

* **認可コードフロー:** ブラウザベースのアプリケーションに適したフロー。ブラウザのリダイレクトを使用して ID トークンとアクセストークンを取得します。
* **インプリシットフロー:** 認可コードフローに似ていますが、リクエスト数が少なく、リフレッシュトークンがありません。セキュリティ上の懸念から、このフローの使用は推奨されません。
* **リソースオーナーパスワードクレデンシャル付与 (ダイレクトアクセスグラント):** REST クライアントがユーザーの代わりにトークンを取得するために使用します。
* **クライアントクレデンシャル付与:** クライアントに関連付けられたサービスアカウントのメタデータと権限に基づいてトークンを作成します。
* **リフレッシュトークン付与:** ほとんどのフローで Keycloak はリフレッシュトークンを返します。
* **デバイス認可付与:** 入力機能が限られている、または適切なブラウザがないインターネット接続デバイスで実行されるクライアントによって使用されます。
* **クライアント開始バックチャネル認証付与:** ユーザーのブラウザを介したリダイレクトなしで、OpenID プロバイダーと直接通信することで認証フローを開始したいクライアントによって使用されます。

### 2.2 SAML

SAML 2.0 は、OIDC と同様の仕様ですが、より成熟しています。認証サーバーとアプリケーション間で XML ドキュメントを交換する認証プロトコルです。

**SAML バインディング:**

* **リダイレクトバインディング:** ブラウザのリダイレクト URI を使用して情報を交換します。
* **POST バインディング:** リダイレクトバインディングに似ていますが、POST リクエストを使用して XML ドキュメントを交換します。
* **ECP:** ウェブブラウザのコンテキスト外で SAML 属性を交換することを可能にする SAML v.2.0 プロファイルです。

**OIDC と SAML の比較:**

* **OIDC:** ウェブでの使用に特化して設計されています。HTML5/JavaScript アプリケーションに適しています。
* **SAML:** OIDC よりも冗長になる可能性があります。既存のアプリケーションとの互換性のために選択されることが多いです。

## 3. Controlling access to the Admin Console (管理コンソールのアクセス制御)

Keycloak では、管理コンソールへのアクセスをきめ細かく制御することができます。

### 3.1 マスターレルムのアクセス制御

マスターレルムは特別なレルムであり、管理者はサーバー上の複数のレルムを管理することができます。

**グローバルロール:**

* **admin:** サーバー上のすべてのレルムを管理するためのフルアクセス権を持つスーパーユーザー。
* **create-realm:** 新しいレルムを作成することができます。

**レルム固有のロール:**

各レルムはマスターレルムのクライアントとして表され、クライアントレベルのロールが定義されています。

* **view-realm:** レルムの表示。
* **manage-realm:** レルムの管理。
* **view-users:** ユーザーの表示。
* **manage-users:** ユーザーの管理。
* **impersonation:** ユーザーのなりすまし。

### 3.2 専用レルム管理コンソール

各レルムには、`/admin/{レルム名}/console` でアクセスできる専用の管理コンソールがあります。ユーザーには、特定のユーザーロールマッピングを割り当てることでレルム管理権限を付与できます。

### 3.3 きめ細かい管理者権限

きめ細かい管理者権限を使用すると、特定のクライアントの管理、特定のグループに属するユーザーの管理、グループのメンバーシップの管理など、レルムの管理に対する制限付きアクセス ポリシーを定義および割り当てることができます.

**例：**

特定のクライアント (sales-application) の管理のみを許可する管理者 (sales-admin) を設定する手順：

1. クライアントの管理セクションに移動し、「権限」タブをクリックします。
2. 「権限を有効にする」スイッチをオンにします。
3. 「管理」権限をクリックし、「ポリシー」タブに移動します。
4. 「ユーザーポリシー」を作成し、sales-admin ユーザーを指定します。
5. sales-application クライアントの「管理」権限ページに戻り、ポリシーを権限オブジェクトに割り当てます。
6. 「ロールマッピング」タブに移動し、「query-clients」ロールを sales-admin に割り当てます。


このドキュメントは Keycloak の機能と管理方法について網羅的に解説しています。より詳細な情報については、ドキュメント全体を参照してください.


Keycloak 16.0.0 から 25.0 のドキュメントに基づき、ご指定の3つの項目の概要を説明します。

**1. Managing organizations**

この機能は、Keycloak realm 内に複数の独立した組織を管理する機能を提供します。企業顧客やパートナー企業など、realm 内で特定のユーザーグループを分離して管理する必要がある場合に役立ちます。

* **組織の作成と管理**: 組織名、ドメイン、説明を設定し、組織メンバーの管理、ID プロバイダーの関連付け、属性の設定などの操作が可能です。
* **メンバー管理**: 既存の realm ユーザーの追加、招待リンクによる新規ユーザー登録、組織に関連付けられた ID プロバイダー経由のメンバー登録など、さまざまな方法で組織メンバーを管理できます。
* **ID プロバイダーの管理**: 組織専用の ID プロバイダーを構成し、メンバーの認証フローを制御できます。
* **認証フローのカスタマイズ**: 組織メンバーの認証方法をカスタマイズできます。例えば、ID プロバイダーへの自動リダイレクトや、組織固有の認証ステップの追加などが可能です。
* **組織クレームのマッピング**: アクセストークンに組織に関する情報を埋め込むことで、アプリケーション側で組織に基づいた認可制御を行うことができます。

**2. Managing OpenID Connect and SAML Clients**

Keycloakは、OpenID Connect (OIDC) と SAML 2.0 の両方のクライアントをサポートしており、アプリケーションのセキュリティ保護とシングルサインオンを実現します。

* **クライアントの作成**: OIDC クライアントと SAML クライアントの両方を作成し、クライアント ID、名前、説明、リダイレクト URI などの基本設定を行うことができます。
* **クライアント認証**: Confidential クライアント (クライアントシークレットを使用) と Public クライアント (クライアントシークレットを使用しない) をサポートし、クライアント認証方法を構成できます。
* **認可フロー**: Authorization Code Flow、Implicit Flow、Direct Access Grants、Client Credentials Grant など、さまざまな OIDC 認可フローをサポートしています。
* **高度な設定**: トークンの有効期限、セッションのタイムアウト、クライアントスコープ、プロトコルマッパー、クライアントポリシーなど、クライアントの動作を細かく設定できます。
* **クライアントアダプタ設定の生成**: Keycloak は、アプリケーションにクライアントアダプタをインストールするために必要な設定ファイルを生成できます。

**3. Using a vault to obtain secrets**

Keycloakは、パスワードやシークレットキーなどの機密情報を外部の vault から取得する機能を提供します。これにより、Keycloak の設定ファイルに機密情報を直接記述する必要がなくなり、セキュリティを向上させることができます。

* **vault の設定**: Keycloak は、プレーンテキストファイルベースの vault と Java KeyStore ベースの vault をサポートしています。
* **機密情報の取得**: 設定フィールドに`${vault.key}`という形式の文字列を記述することで、vault から機密情報を取得できます。
* **Key resolver**: realm 名と key を組み合わせて vault 内のエントリ名を生成するためのアルゴリズムを指定できます。
* **サポートされるフィールド**: SMTP パスワード、LDAP バインド資格情報、OIDC ID プロバイダーシークレットなどのフィールドで vault を使用できます。

これらの機能により、Keycloak を使用してアプリケーションのセキュリティを強化し、組織やユーザーを効率的に管理することができます。


**Keycloak** は、Web アプリケーションと RESTful Web サービス向けのシングルサインオンソリューションです。

### Configuring auditing to track events (イベント追跡のための監査設定)

Keycloak では、ユーザーと管理者のアクティビティに関するイベントを記録し、監査することができます。

* **ユーザーイベント**: ログイン、登録、ログアウト、パスワードリセット、プロファイル更新などのユーザーアクションに関するイベントを記録します。
* **管理イベント**: レルム、クライアント、ユーザー、ロール、グループの管理に関する管理アクションを記録します。
* **イベントリスナー**: イベントが発生したときにアクションを実行するイベントリスナーを設定できます。例えば、ログインエラーが発生したときにメールを送信する、不正アクセスを検知したときにアカウントをロックするなどのアクションを設定できます。

デフォルトでは、イベントは Keycloak データベースに保存されます。イベントの保存期間は設定可能です。イベントは、管理コンソールで確認したり、管理 REST API を使用して取得したりできます。

### Mitigating security threats (セキュリティ脅威の緩和)

Keycloak は、以下のようなセキュリティ脅威に対する対策を提供しています。

* **ブルートフォース攻撃**: ログイン試行の失敗回数が多い場合、アカウントを一時的にロックしたり、永続的に無効化したりすることができます。
* **パスワードポリシー**: 複雑なパスワードポリシーを設定することで、パスワード推測攻撃を防ぐことができます。
* **クリックジャッキング**: X-Frame-Options ヘッダーと Content-Security-Policy ヘッダーを設定することで、クリックジャッキング攻撃を防ぐことができます。
* **SSL/HTTPS**: Keycloak サーバーとクライアント間の通信を SSL/HTTPS で保護することで、中間者攻撃を防ぐことができます。
* **CSRF 攻撃**: OAuth 2.0 の state パラメータと cookie を使用することで、CSRF 攻撃を防ぐことができます。
* **オープンリダイレクタ**: リダイレクト URI のパターンを厳密に設定することで、オープンリダイレクタ攻撃を防ぐことができます。
* **FAPI**: Financial-grade API (FAPI) 準拠のセキュリティプロファイルを適用することで、金融機関向けのセキュリティ要件を満たすことができます。
* **OAuth 2.1**: OAuth 2.1 準拠のセキュリティプロファイルを適用することで、最新のセキュリティ要件を満たすことができます。

### Account Console (アカウントコンソール)

Keycloak のユーザーは、アカウントコンソールを使用して自分のアカウントを管理できます。

* **プロフィール**: ユーザー名、メールアドレス、パスワードなどのプロフィール情報を管理できます。
* **2 要素認証**: OTP または WebAuthn を使用した 2 要素認証を設定できます。
* **デバイスアクティビティ**: アカウントにログインしているデバイスを確認できます。
* **リンクアカウント**: ソーシャルプロバイダーなどの ID プロバイダーアカウントをリンクできます。
* **アプリケーション**: アクセスできるアプリケーションを確認できます。

### Admin CLI (管理 CLI)

Keycloak の管理 CLI は、コマンドラインから Keycloak サーバーを管理するためのツールです。

* **認証**: ユーザー名とパスワード、またはクライアント ID とシークレットを使用して Keycloak サーバーに認証できます。
* **レルム操作**: レルムの作成、更新、削除、エクスポート、インポートなどの操作を実行できます。
* **クライアント操作**: クライアントの作成、更新、削除、アダプター設定の生成などの操作を実行できます。
* **ユーザー操作**: ユーザーの作成、更新、削除、パスワードリセット、ロールマッピングなどの操作を実行できます。
* **グループ操作**: グループの作成、更新、削除、メンバー管理、ロールマッピングなどの操作を実行できます。
* **ID プロバイダー操作**: ID プロバイダーの作成、更新、削除、マッピング設定などの操作を実行できます。
* **ストレージプロバイダー操作**: LDAP や Kerberos などのストレージプロバイダーの設定と管理を行うことができます。
* **認証操作**: パスワードポリシーの設定、認証フローの管理、実行設定などの操作を実行できます。

管理 CLI は、スクリプトを作成して Keycloak サーバーを自動的に管理する場合に特に便利です。

