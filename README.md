## Keycloak 分散キャッシュの影響に関する考察

Keycloakは、Infinispanを利用した分散キャッシュにより、高可用性とクラスタ環境を実現します。

**分散キャッシュを使用しない場合の影響:**

* **パフォーマンス低下:** 各ノードはデータベースへのアクセスが独立しているため、頻繁にデータを取得する必要がある状況ではパフォーマンスが低下します。
* **可用性低下:** 単一のノードがダウンすると、そのノード上のデータにアクセスできなくなり、利用者はログアウトさせられる可能性があります。
* **セッション管理の複雑化:** 複数のノード間でセッションを管理するのが複雑になり、セッションアフィニティの確保も難しくなります。

**分散キャッシュを使用した場合のメリット:**

* **パフォーマンス向上:** データがノード間で共有されるため、データベースへのアクセス回数を減らし、パフォーマンスを向上させます。
* **高可用性:** あるノードがダウンしても、他のノードがそのデータの複製を持っているため、サービスが継続的に提供されます。
* **セッション管理の簡素化:** 分散キャッシュにより、セッションはクラスタ全体で共有され、セッション管理が容易になります。

**キャッシュの種類と役割:**

Keycloakでは、以下のキャッシュが利用されます。

* **Local キャッシュ:** realms、users、authorization、keys データをローカルにキャッシュします。データベースへのアクセスを減らし、パフォーマンス向上に役立ちます。
* **Replicated キャッシュ:** work キャッシュとして使用され、Local キャッシュの無効化メッセージを他のノードに伝播します。
* **Distributed キャッシュ:** authenticationSessions、sessions、clientSessions、offlineSessions、offlineClientSessions、loginFailures、actionTokens をキャッシュし、セッション管理やブルートフォース攻撃対策などに役立ちます。

**分散キャッシュの設定:**

* **cache-config-file:** キャッシュ設定ファイルのパスを指定します。
* **cache-stack:** 使用するトランスポートスタックを指定します。
* **cache-remote-host:** リモートキャッシュサーバーのホスト名を指定します。
* **cache-remote-username/password:** リモートキャッシュサーバーへの認証情報です。

**分散キャッシュの運用:**

* **キャッシュサイズ:** キャッシュサイズが大きすぎるとメモリの消費量が増加します。最適なサイズを見つける必要があります。
* **キャッシュ有効期限:** キャッシュの有効期限を設定して、古いデータがキャッシュに保持されないようにします。
* **キャッシュ監視:** キャッシュの状態を監視し、必要に応じて設定を調整します。

**セッションアフィニティ:**

セッションアフィニティとは、同一ユーザーのセッションを常に同じノードに割り当てる機能です。Keycloakでは、分散キャッシュを用いることでセッションアフィニティが実現できます。
