## Cloud Run 上での Keycloak 複数インスタンス起動における分散キャッシュの影響

添付のドキュメント「Configuring distributed caches」を参考に、Cloud Run 上に Keycloak 複数インスタンスを起動した場合の分散キャッシュの有り無しの影響について整理します。

**前提:**

* Cloud Run 上で Keycloak 複数インスタンスを起動し、ロードバランサーで負荷分散を実施する。
* ロードバランサー側でセッションアフィニティが有効化されている。

**分散キャッシュ無しの場合**

* 各インスタンスは独立して動作するため、セッション情報や認証関連情報は各インスタンスにローカルに保持されます。
* セッションアフィニティが有効化されているため、同一ユーザーは常に同一インスタンスに接続します。
* 1 つのインスタンスがダウンしても、他のインスタンスは影響を受けずに動作します。
* データベースへのアクセス頻度が増加し、パフォーマンス低下に繋がる可能性があります。
* セッションデータはインスタンスにローカルに保存されるため、インスタンスの再起動や停止でデータが失われます。

**分散キャッシュ有りの場合**

* 各インスタンスは分散キャッシュを通じて、セッション情報や認証関連情報を共有します。
* セッションアフィニティが有効化されているため、同一ユーザーは常に同一インスタンスに接続し、キャッシュデータはローカルに取得します。
* 1 つのインスタンスがダウンしても、分散キャッシュを通じて他のインスタンスからデータを取得できるため、サービスが継続的に動作します。
* データベースへのアクセス頻度が減り、パフォーマンス向上に繋がる可能性があります。
* セッションデータは分散キャッシュに保存されるため、インスタンスの再起動や停止でもデータは保持されます。
* 分散キャッシュの構成や運用に複雑さが増します。
* 分散キャッシュの構成によっては、ネットワーク帯域やCPU負荷が増加する可能性があります。

**結論**

Cloud Run 上で Keycloak 複数インスタンスを起動し、高可用性とパフォーマンスの両立を目指す場合は、分散キャッシュの導入を検討する必要があります。

**分散キャッシュのメリット:**

* 高可用性を実現
* パフォーマンス向上
* セッションデータの永続化

**分散キャッシュのデメリット:**

* 構成と運用が複雑
* リソース消費増加の可能性

分散キャッシュの導入は、Keycloak の規模や利用状況に応じて判断する必要があります。
