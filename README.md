## Keycloakの概要：初心者向け解説

Keycloakは、WebアプリケーションやRESTful Webサービス向けのシングルサインオン（SSO）ソリューションです。簡単に言うと、Keycloakはアプリケーション開発者が組織内のアプリケーションやサービスを安全に構築するためのセキュリティ機能を、簡単に使用できるように提供します。

### Keycloakの利点

* **セキュリティの簡素化:** 開発者が自分で実装する必要のあるセキュリティ機能を、Keycloakは標準装備で提供します。
* **カスタマイズ可能なUI:** ログイン、登録、管理、アカウント管理などのためのUIをカスタマイズできます。
* **統合性:** 既存のLDAPやActive Directoryサーバーとの統合が可能です。
* **サードパーティ認証:** FacebookやGoogleなどのサードパーティIDプロバイダーとの連携が可能です。

### Keycloakの主要機能

* **シングルサインオン（SSO）/シングルサインアウト:** ブラウザアプリケーションへのSSO/SSOを実現します。
* **OpenID ConnectとOAuth 2.0サポート:** 標準的な認証・認可プロトコルをサポートします。
* **Identity Brokering:** 外部のOpenID ConnectやSAML IDプロバイダーによる認証が可能です。
* **ソーシャルログイン:** Google、GitHub、Facebook、Twitterなどのソーシャルネットワークでのログインを有効化できます。
* **ユーザーフェデレーション:** LDAPやActive Directoryサーバーからユーザーを同期できます。
* **Kerberosブリッジ:** Kerberosサーバーにログインしているユーザーを自動的に認証できます。
* **管理コンソール:** ユーザー、ロール、ロールマッピング、クライアント、設定などを一元的に管理できます。
* **アカウントコンソール:** ユーザーが自分のアカウントを一元的に管理できます。
* **テーマサポート:** ユーザー向けのページをカスタマイズして、アプリケーションやブランドに統合できます。
* **二要素認証:** Google AuthenticatorやFreeOTPなどのTOTP/HOTPをサポートします。
* **ログインフロー:** ユーザーのセルフレジストレーション、パスワード回復、メール確認、パスワード更新などのオプション機能を提供します。
* **セッション管理:** 管理者とユーザーは、ユーザーセッションを閲覧および管理できます。
* **トークンマッパー:** ユーザー属性、ロールなどをトークンとステートメントにマッピングできます。

### Keycloakの基本的な動作

Keycloakはネットワーク上で管理する別のサーバーです。アプリケーションはKeycloakサーバーをポイントし、そのサーバーによってセキュリティ保護されます。Keycloakは、OpenID ConnectやSAML 2.0などのオープンなプロトコル標準を使用して、アプリケーションを保護します。

ブラウザアプリケーションは、ユーザーのブラウザをアプリケーションからKeycloak認証サーバーにリダイレクトします。ユーザーは自分の資格情報をKeycloakサーバーに入力します。このリダイレクトは重要です。ユーザーはアプリケーションから完全に隔離され、アプリケーションはユーザーの資格情報を直接見ることができません。代わりに、アプリケーションは、暗号的に署名されたアイデンティティトークンまたはアサーションを受け取ります。これらのトークンには、ユーザー名、住所、メールアドレス、その他のプロファイルデータなどのアイデンティティ情報が含まれます。アプリケーションは、これらのトークンを使用して、リソースへのアクセスを許可したり、拒否したりすることができます。

### Keycloakの基本概念と用語

* **ユーザー:** システムにログインできるエンティティ。メールアドレス、ユーザー名、住所、電話番号、誕生日などの属性を関連付けることができます。
* **認証:** ユーザーを識別し、検証するプロセス。
* **認可:** ユーザーにアクセス権を与えるプロセス。
* **資格情報:** Keycloakがユーザーのアイデンティティを検証するために使用するデータ。パスワード、ワンタイムパスワード、デジタル証明書、指紋などが挙げられます。
* **ロール:** ユーザーの種類またはカテゴリーを識別します。管理者、ユーザー、マネージャー、従業員などは、組織に存在する一般的なロールです。
* **ユーザーロールマッピング:** ユーザーとロールのマッピングを定義します。ユーザーは、0個以上のロールに関連付けることができます。
* **複合ロール:** 他のロールに関連付けることができるロール。
* **グループ:** ユーザーのグループを管理します。
* **レルム:** ユーザー、資格情報、ロール、グループを管理します。ユーザーはレルムに属し、レルムにログインします。
* **クライアント:** Keycloakにユーザーの認証を要求できるエンティティ。クライアントは、多くの場合、アプリケーションやサービスです。
* **クライアントアダプター:** アプリケーション環境にインストールするプラグイン。Keycloakとの通信を可能にし、Keycloakによってセキュリティ保護されます。

### 可用性とスケーラビリティの確保

Keycloakは、高可用性とスケーラビリティを実現するために、次の点に配慮する必要があります。

* **クラスタリング:** 複数のKeycloakサーバーをクラスタリングすることで、障害発生時の耐障害性を向上させることができます。
* **ロードバランシング:** 複数のKeycloakサーバーにトラフィックを分散することで、サーバーの負荷を軽減し、パフォーマンスを向上させることができます。
* **データベース:** Keycloakのデータを保存するデータベースは、高可用性とスケーラビリティを備えている必要があります。
* **キャッシュ:** Keycloakは、頻繁にアクセスされるデータ（ユーザー情報、ロール情報など）をキャッシュすることで、パフォーマンスを向上させることができます。

Keycloakは、Google Cloud Run上で動作させることができます。Google Cloud Runは、サーバーレスコンテナプラットフォームです。Google Cloud Runを使用すると、Keycloakの可用性とスケーラビリティを簡単に確保することができます。
