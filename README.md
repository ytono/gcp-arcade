## Admin REST API

KeycloakはAdmin Consoleの全機能を備えたAdmin REST APIを提供しています。APIを使用するには、適切な権限を持つアクセストークンを取得する必要があります。
例として、curlコマンドを使ったユーザー名とパスワードによる認証、サービスアカウントによる認証、Javaクライアントライブラリを使った認証方法が紹介されています。

## Themes

Keycloakは、Webページとメールのテーマをサポートしています。これにより、エンドユーザー向けのページのルックアンドフィールをカスタマイズして、アプリケーションと統合することができます。

### テーマの種類

テーマは、Keycloakの様々な側面をカスタマイズするための1つ以上のタイプを提供できます。利用可能なタイプは以下の通りです。

- Account：アカウントコンソール
- Admin：管理コンソール
- Email：メール
- Login：ログインフォーム
- Welcome：ウェルカムページ

### デフォルトテーマ

Keycloakには、サーバーディストリビューション内のJARファイル`keycloak-themes-25.0.1.jar`にデフォルトのテーマがバンドルされています。アップグレードを簡単にするために、バンドルされたテーマを直接編集しないでください。代わりに、バンドルされたテーマのいずれかを拡張する独自のテーマを作成します。

### テーマの作成

テーマは、HTMLテンプレート、画像、メッセージバンドル、スタイルシート、スクリプト、テーマプロパティで構成されています。

テーマを作成する手順は以下の通りです。

1. `--spi-theme-static-max-age=-1 --spi-theme-cache-themes=false --spi-theme-cache-templates=false`オプションを付けてKeycloakを実行します。
2. `themes`ディレクトリにディレクトリを作成します。ディレクトリの名前がテーマの名前になります。
3. テーマディレクトリの中に、テーマが提供する各タイプ用のディレクトリを作成します。
4. 各タイプに、テーマの設定を行う`theme.properties`ファイルを作成します。

### テーマプロパティ

テーマプロパティは、テーマディレクトリの`<THEME TYPE>/theme.properties`ファイルで設定します。

- `parent`：拡張する親テーマ
- `import`：別のテーマからリソースをインポートする
- `styles`：インクルードするスタイルのスペース区切りのリスト
- `locales`：サポートされているロケールのカンマ区切りのリスト

### スタイルシートをテーマに追加する

テーマに1つ以上のスタイルシートを追加できます。

### スクリプトをテーマに追加する

テーマに1つ以上のスクリプトを追加できます。

### 画像をテーマに追加する

テーマで画像を使用できるようにするには、テーマの`<THEME TYPE>/resources/img`ディレクトリに追加します。これらは、スタイルシート内またはHTMLテンプレートで直接使用できます。

### メッセージ

テンプレートのテキストは、メッセージバンドルから読み込まれます。別のテーマを拡張するテーマは、親のメッセージバンドルからすべてのメッセージを継承し、テーマに`<THEME TYPE>/messages/messages_en.properties`を追加することで、個々のメッセージを上書きできます。

### 言語をレルムに追加する

レルムの国際化を有効にするには、サーバー管理ガイドを参照してください。

### カスタムIDプロバイダーのアイコンを追加する

Keycloakは、ログイン画面に表示されるカスタムIDプロバイダーのアイコンの追加をサポートしています。

### カスタムHTMLテンプレートの作成

Keycloakは、HTMLを生成してページをレンダリングするために、Apache Freemarkerテンプレートを使用しています。

### メール

パスワード回復メールなどのメールの件名と内容を編集するには、テーマのメールタイプにメッセージバンドルを追加します。

### テーマのデプロイ

テーマは、テーマディレクトリにテーマディレクトリをコピーすることでKeycloakにデプロイするか、アーカイブとしてデプロイできます。

### テーマセレクタ

デフォルトでは、クライアントがログインテーマをオーバーライドできる場合を除き、レルムに設定されたテーマが使用されます。この動作は、テーマセレクタSPIを通じて変更できます。

### テーマリソース

Keycloakでカスタムプロバイダーを実装する場合、追加のテンプレート、リソース、メッセージバンドルを追加する必要があることがよくあります。

### ロケールセレクタ

デフォルトでは、ロケールはLocaleSelectorProviderインターフェースを実装するDefaultLocaleSelectorProviderを使用して選択されます。国際化が無効になっている場合、デフォルトの言語は英語です。

### IDブローカリングAPI

Keycloakは、ログインのための親IDPへの認証を委任することができます。この典型的な例は、FacebookやGoogleなどのソーシャルプロバイダーを通じてユーザーがログインできるようにする場合です。また、既存のアカウントをブローカーIDPにリンクすることもできます。

#### 外部IDPトークンの取得

Keycloakでは、外部IDPとの認証プロセスからのトークンと応答を保存できます。そのためには、IDPの設定ページで「トークンの保存」設定オプションを使用できます。

#### クライアントが開始したアカウントのリンク

アプリケーションの中には、Facebookのようなソーシャルプロバイダーと統合したいが、これらのソーシャルプロバイダーを介してログインするオプションを提供したくないものがあります。Keycloakは、アプリケーションが既存のユーザーアカウントを特定の外部IDPにリンクするために使用できるブラウザベースのAPIを提供しています。これをクライアントが開始したアカウントのリンクと呼びます。アカウントのリンクは、OIDCアプリケーションによってのみ開始できます。

#### 外部トークンの更新

プロバイダー（FacebookやGitHubのトークンなど）へのログインによって生成された外部トークンを使用している場合、アカウントのリンクAPIを再起動することで、このトークンを更新できます。


このドキュメントは Keycloak サーバー (バージョン 16.0.0 から 25.0) の拡張方法について解説しています。

特に、**サービスプロバイダーインターフェース (SPI)** と呼ばれる機構を通じてサーバーの様々な側面をカスタマイズする方法に焦点を当てています。

## サービスプロバイダーインターフェース (SPI)

Keycloak は、カスタムコードなしで多くのユースケースに対応できるように設計されていますが、カスタマイズ性も重視しています。
そのため、独自のプロバイダーを実装できる SPI を多数用意しています。

### SPI の実装

SPI を実装するには、`ProviderFactory` と `Provider` インターフェースを実装する必要があります。
また、サービス設定ファイルを作成する必要もあります。

例えば、テーマセレクター SPI を実装するには、`ThemeSelectorProviderFactory` と `ThemeSelectorProvider` を実装し、`META-INF/services/org.keycloak.theme.ThemeSelectorProviderFactory` ファイルを提供する必要があります。

### 利用可能な SPI

Keycloak には、認証、イベントリスニング、ユーザーストレージ、テーマなど、様々な機能を拡張するための SPI が用意されています。

主要な SPI について簡単に説明します。

- **認証 SPI:** Kerberos、パスワード、OTP などの認証メカニズムに加えて、独自の認証メカニズムをプラグインできます。
また、登録フォームにページを追加したり、完全に再実装したりすることもできます。
- **アクションハンドラ SPI:** パスワードリセットやメールアドレス検証など、ユーザーが実行できるアクションを定義するアクショントークンを処理するための独自のハンドラを実装できます。
- **イベントリスナー SPI:** ログイン、ログアウト、登録などのイベントが発生したときにカスタムロジックを実行するイベントリスナーを作成できます。
- **SAML ロールマッピング SPI:** サードパーティ ID プロバイダーから返された SAML ロールを、サービスプロバイダー環境のロールにマッピングできます。
- **ユーザーストレージ SPI:** 外部ユーザーデータベースや認証情報ストアに接続するための拡張機能を作成できます。
組み込みの LDAP と Active Directory のサポートはこの SPI の実装例です。
- **Vault SPI:** Keycloak がパスワードや証明書などの機密データを保存するために使用する vault をカスタマイズできます。

## サーバーの拡張

Keycloak の SPI フレームワークは、特定の組み込みプロバイダーを実装またはオーバーライドする機能を提供します。
しかし、Keycloak は、そのコア機能とドメインを拡張する機能も提供しています。

これには、以下のような機能が含まれます。

- Keycloak サーバーへのカスタム REST エンドポイントの追加
- 独自の SPI の追加
- Keycloak データモデルへのカスタム JPA エンティティの追加

### カスタム REST エンドポイントの追加

これは非常に強力な拡張機能で、Keycloak サーバーに独自の REST エンドポイントをデプロイできます。
これにより、デフォルトの組み込み Keycloak REST エンドポイントでは利用できない、Keycloak サーバーの機能をトリガーするなど、あらゆる種類の拡張が可能になります。

カスタム REST エンドポイントを追加するには、`RealmResourceProviderFactory` と `RealmResourceProvider` インターフェースを実装する必要があります。

## 結論

Keycloak は、SPI とサーバー拡張機能を通じて高度なカスタマイズが可能です。
これらの機構を使用することで、Keycloak を組織の特定のニーズに合わせて調整できます。
