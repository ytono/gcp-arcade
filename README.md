## Keycloak の分散キャッシュ設定ガイド

このドキュメントは、Keycloak で分散キャッシュを使用する方法について説明します。分散キャッシュは、Keycloak の高可用性とマルチノードクラスタ設定を実現する上で重要な要素です。

### 分散キャッシュの概要

Keycloak は、高可用性とマルチノードクラスタ設定を実現するために設計されています。現在の分散キャッシュ実装は、高性能で分散可能なインメモリデータグリッドである Infinispan を基盤として構築されています。

### 分散キャッシュの有効化

Keycloak を本番モードで起動する際 ( `start` コマンドを使用)、キャッシュが有効になり、ネットワーク上のすべての Keycloak ノードが検出されます。

デフォルトでは、キャッシュは UDP トランスポートスタックを使用しているため、ノードは UDP ベースの IP マルチキャストトランスポートを使用して検出されます。ほとんどの本番環境では、UDP よりも優れた検出方法があります。Keycloak では、事前に定義されたデフォルトのトランスポートスタックから選択するか、後で説明するカスタムスタックを定義することができます。

分散 Infinispan キャッシュを明示的に有効にするには、次のコマンドを入力します。

```
bin/kc.[sh|bat] build --cache=ispn
```

Keycloak を開発モードで起動する際 ( `start-dev` コマンドを使用)、Keycloak はローカルキャッシュのみを使用し、分散キャッシュは `--cache=local` オプションを暗黙的に設定することで完全に無効になります。ローカルキャッシュモードは、開発およびテスト目的でのみ使用することを目的としています。

### キャッシュの設定

Keycloak は、デフォルト設定が設定されたキャッシュ設定ファイル (`conf/cache-ispn.xml`) を提供しています。

キャッシュ設定は、通常の Infinispan 設定ファイルです。

次の表は、Keycloak が使用する特定のキャッシュの概要を示しています。これらのキャッシュは、`conf/cache-ispn.xml` で設定できます。

| キャッシュ名 | キャッシュタイプ | 説明 |
|---|---|---|
| realms | ローカル | 永続化されたレルムデータをキャッシュ |
| users | ローカル | 永続化されたユーザーデータをキャッシュ |
| authorization | ローカル | 永続化された認可データをキャッシュ |
| keys | ローカル | 外部公開鍵をキャッシュ |
| work | 複製 | 無効化メッセージをノード間で伝播 |
| authenticationSessions | 分散 | 認証プロセス中に作成、破棄、または期限切れになった認証セッションをキャッシュ |
| sessions | 分散 | 認証に成功すると作成され、ログアウト、トークンの失効、または期限切れのために破棄されるユーザーセッションをキャッシュ |
| clientSessions | 分散 | 特定のクライアントへの認証に成功すると作成され、ログアウト、トークンの失効、または期限切れのために破棄されるクライアントセッションをキャッシュ |
| offlineSessions | 分散 | 認証に成功すると作成され、ログアウト、トークンの失効、または期限切れのために破棄されるオフラインユーザーセッションをキャッシュ |
| offlineClientSessions | 分散 | 特定のクライアントへの認証に成功すると作成され、ログアウト、トークンの失効、または期限切れのために破棄されるオフラインクライアントセッションをキャッシュ |
| loginFailures | 分散 | ログイン失敗を追跡 (不正行為検出) |
| actionTokens | 分散 | アクショントークンをキャッシュ |

### キャッシュの種類とデフォルト

**ローカルキャッシュ**

Keycloak は、データベースへの不要なラウンドトリップを回避するために、永続的なデータをローカルにキャッシュします。

次のデータは、ローカルキャッシュを使用してクラスタ内の各ノードにローカルに保持されます。

* レルムとその関連データ (クライアント、ロール、グループ)
* ユーザーとその関連データ (付与されたロール、グループメンバーシップ)
* 認可とその関連データ (リソース、権限、ポリシー)
* 鍵

レルム、ユーザー、認可のローカルキャッシュは、デフォルトで最大 10,000 エントリを保持するように設定されています。ローカル鍵キャッシュは、デフォルトで最大 1,000 エントリを保持し、デフォルトで 1 時間ごとに期限切れになります。そのため、鍵は外部クライアントまたはアイデンティティプロバイダーから定期的にダウンロードされます。

最適なランタイムを実現し、データベースへの追加のラウンドトリップを回避するために、各キャッシュの設定を確認して、最大エントリ数がデータベースのサイズに合っていることを確認する必要があります。キャッシュできるエントリが多いほど、サーバーがデータベースからデータを取得する頻度は低くなります。メモリ使用量とパフォーマンスのトレードオフを評価する必要があります。

**ローカルキャッシュの無効化**

ローカルキャッシュはパフォーマンスを向上させますが、マルチノード設定では課題が発生します。

1 つの Keycloak ノードが共有データベース内のデータを更新すると、他のすべてのノードがそのことを認識して、自分のキャッシュからそのデータを無効にする必要があります。

`work` キャッシュは複製されたキャッシュであり、これらの無効化メッセージを送信するために使用されます。このキャッシュのエントリ/メッセージは非常に短命であり、このキャッシュが時間の経過とともにサイズが大きくなるとは想定すべきではありません。

**認証セッション**

ユーザーが認証しようとすると、認証セッションが作成されます。認証セッションは、認証プロセスが完了するか、期限切れになるまで自動的に破棄されます。

`authenticationSessions` 分散キャッシュは、認証プロセス中に認証セッションとその関連データを保存するために使用されます。

分散可能なキャッシュに依存することで、認証セッションはクラスタ内のどのノードでも利用可能になり、ユーザーは認証状態を失うことなくどのノードにもリダイレクトできます。ただし、本番環境での展開では、常にセッションアフィニティを考慮し、ユーザーをセッションが最初に作成されたノードにリダイレクトすることをお勧めします。これにより、ノード間での不要な状態転送を回避し、CPU、メモリ、ネットワークの使用率を向上させることができます。

**ユーザーセッション**

ユーザーが認証されると、ユーザーセッションが作成されます。ユーザーセッションは、アクティブなユーザーとその状態を追跡するため、ユーザーは資格情報を再度要求されることなく、あらゆるアプリケーションにシームレスに認証できます。ユーザーが認証する各アプリケーションには、クライアントセッションも作成されます。これにより、サーバーはユーザーが認証されているアプリケーションとそのアプリケーションごとの状態を追跡できます。

ユーザーセッションとクライアントセッションは、ユーザーがログアウトを実行するか、クライアントがトークンの失効を実行するか、または期限切れになるまで自動的に破棄されます。

次のキャッシュは、ユーザーセッションとクライアントセッションの両方を保存するために使用されます。

* `sessions`
* `clientSessions`

分散可能なキャッシュに依存することで、ユーザーセッションとクライアントセッションはクラスタ内のどのノードでも利用可能になり、ユーザーは認証状態を失うことなくどのノードにもリダイレクトできます。ただし、本番環境での展開では、常にセッションアフィニティを考慮し、ユーザーをセッションが最初に作成されたノードにリダイレクトすることをお勧めします。これにより、ノード間での不要な状態転送を回避し、CPU、メモリ、ネットワークの使用率を向上させることができます。

**永続的なユーザーセッション**

`persistent-user-sessions` 機能は、オンラインユーザーセッションとクライアントセッションをデータベースにも保存します。これにより、Keycloak のすべてのインスタンスが再起動またはアップグレードされても、ユーザーはログインした状態を維持できます。

この機能はデフォルトでは無効になっています。使用する場合は、次のコマンドを使用して機能を有効にします。

```
bin/kc.sh start --features=persistent-user-sessions ...
```

この機能を有効にすると、オンラインユーザーセッションとオンラインクライアントセッションのインメモリキャッシュは、デフォルトでノードあたり 10,000 エントリに制限されるため、大規模なインストールでの Keycloak の全体的なメモリ使用量が削減されます。内部キャッシュは、各キャッシュエントリの所有者を 1 つのみで実行します。メモリから追放されたアイテムは、必要に応じてデータベースからオンデマンドでロードされます。キャッシュのサイズを異なるサイズに設定するには、Keycloak のキャッシュ設定ファイルを編集して、それらのキャッシュの `<memory max-count="..."/>` を設定します。

ローリング構成アップグレードでこの機能を有効にすると、永続化されたセッションと永続化されていないセッションが共存する場合、Keycloak のセッションに関する動作が未定義になる可能性があります。これを防ぐには、最初のノードが有効な状態で起動される前に、すべてのオンラインユーザーセッションとクライアントセッションを削除します。つまり、すべての Keycloak ノードを停止し、使用されている場合は、Infinispan リモートキャッシュストアと組み込み Infinispan JDBC パーシスタンスをクリアする必要があります。

**オフラインユーザーセッション**

OpenID Connect プロバイダーとして、サーバーはユーザーを認証し、オフライントークンを発行することもできます。通常のユーザーセッションとクライアントセッションと同様に、認証に成功するとサーバーがオフライントークンを発行すると、サーバーはオフラインユーザーセッションとオフラインクライアントセッションも作成します。ただし、オフライントークンの性質上、オフラインセッションは、長期間存続し、クラスタの完全なシャットダウンを乗り越える必要があるため、異なる方法で処理されます。そのため、データベースにも永続化されます。

次のキャッシュは、オフラインセッションの保存に使用されます。

* `offlineSessions`
* `offlineClientSessions`

クラスタの再起動時に、オフラインセッションはデータベースから遅延ロードされ、上記の 2 つのキャッシュを使用して共有キャッシュに保持されます。

`persistent-user-sessions` 機能を有効にすると、オフラインユーザーセッションとオフラインクライアントセッションのインメモリキャッシュは 10,000 エントリに制限されるため、大規模なインストールでの Keycloak の全体的なメモリ使用量が削減されます。メモリから追放されたアイテムは、必要に応じてデータベースからオンデマンドでロードされます。キャッシュのサイズを異なるサイズに設定するには、Keycloak のキャッシュ設定ファイルを編集して、それらのキャッシュの `<memory max-count="..."/>` を設定します。

**パスワードのブルートフォース検出**

`loginFailures` 分散キャッシュは、ログイン失敗に関するデータを追跡するために使用されます。このキャッシュは、マルチノード Keycloak 設定でブルートフォース保護機能が動作するために必要です。

**アクショントークン**

アクショントークンは、ユーザーがアクションを非同期に確認する必要がある場合 (たとえば、パスワード忘れフローで送信されるメールの場合) に使用されます。`actionTokens` 分散キャッシュは、アクショントークンに関するメタデータを追跡するために使用されます。

### 高可用性のためのキャッシュの設定

分散キャッシュは、クラスタ内のノードのサブセットにキャッシュエントリを複製し、エントリを固定された所有者ノードに割り当てます。

各分散キャッシュは、デフォルトで 2 つの所有者を持ち、つまり 2 つのノードが特定のキャッシュエントリの複製を持っています。所有者ではないノードは、特定のキャッシュの所有者にクエリを実行してデータを取得します。両方の所有者ノードがオフラインになると、すべてのデータが失われます。この状況は、通常、ユーザーが次の要求時にログアウトして、再度ログインすることになります。

所有者のデフォルト数は、少なくとも 3 つのノードを持つクラスタ設定で、1 つのノード (所有者) の障害を乗り越えるのに十分です。可用性要件に合わせて、所有者の数を自由に変更できます。所有者の数を変更するには、`conf/cache-ispn.xml` を開き、分散キャッシュの `owners=<value>` の値を目的の値に変更します。

### カスタムキャッシュ設定ファイルの指定

カスタムキャッシュ設定ファイルを指定するには、次のコマンドを入力します。

```
bin/kc.[sh|bat] build --cache-config-file=my-cache-file.xml
```

設定ファイルは、`conf/` ディレクトリに対する相対パスです。

### リモートサーバーの CLI オプション

高可用性とマルチノードクラスタ設定を実現するための Keycloak サーバーの構成には、`cache-remote-host`、`cache-remote-port`、`cache-remote-username`、`cache-remote-password` という CLI オプションが導入され、XML ファイル内の構成が簡素化されました。これらの CLI パラメータが設定されている場合は、XML ファイルにリモートストアに関連する設定が含まれていないことが期待されます。

### セキュリティが設定されていない Infinispan サーバーへの接続

**本番環境では、セキュリティを無効にすることはお勧めしません。**

開発またはテスト環境では、セキュリティが設定されていない Infinispan サーバーを起動する方が簡単です。このようなユースケースでは、`cache-remote-tls-enabled` CLI オプションを使用して、Keycloak と Infinispan 間の暗号化 (TLS) を無効にすることができます。Infinispan サーバーが暗号化された接続のみを受け入れるように設定されている場合、Keycloak は起動に失敗します。

`cache-remote-username` と `cache-remote-password` CLI オプションはオプションであり、設定されていない場合、Keycloak は認証情報を提示せずに Infinispan サーバーに接続します。Infinispan サーバーで認証が有効になっている場合、Keycloak は起動に失敗します。

### トランスポートスタック

トランスポートスタックは、クラスタ内の分散キャッシュノードが確実に信頼性の高い方法で通信できるようにします。Keycloak は、さまざまなトランスポートスタックをサポートしています。

特定のキャッシュスタックを適用するには、次のコマンドを入力します。

```
bin/kc.[sh|bat] build --cache-stack=<stack>
```

デフォルトのスタックは、分散キャッシュが有効になっている場合は `udp` に設定されています。

**利用可能なトランスポートスタック**

次の表は、`--cache-stack` ビルドオプションを使用する以外に、追加の構成なしで利用可能なトランスポートスタックを示しています。

| スタック名 | トランスポートプロトコル | 検出 |
|---|---|---|
| tcp | TCP | MPING (UDP マルチキャストを使用) |
| udp | UDP | UDP マルチキャスト |

次の表は、`--cache-stack` ビルドオプションと最小限の構成を使用して利用可能なトランスポートスタックを示しています。

| スタック名 | トランスポートプロトコル | 検出 |
|---|---|---|
| kubernetes | TCP | DNS_PING (JAVA_OPTS または JAVA_OPTS_APPEND 環境変数に `-Djgroups.dns.query=<headless-service-FQDN>` を追加する必要がある) |

**追加のトランスポートスタック**

次の表は、Keycloak でサポートされているが、動作させるために追加の手順が必要なトランスポートスタックを示しています。これらのスタックは、いずれも Kubernetes / OpenShift スタックではないため、Google Kubernetes Engine で Keycloak を実行する場合、Google スタックを有効にする必要はありません。その場合は、`kubernetes` スタックを使用してください。代わりに、AWS EC2 インスタンスで実行されている分散キャッシュ設定がある場合は、`ec2` スタックに設定する必要があります。これは、`ec2` は UDP などのデフォルトの検出メカニズムをサポートしていないためです。

| スタック名 | トランスポートプロトコル | 検出 |
|---|---|---|
| ec2 | TCP | NATIVE_S3_PING |
| google | TCP | GOOGLE_PING2 |
| azure | TCP | AZURE_PING |

クラウドベンダー固有のスタックには、Keycloak の追加の依存関係があります。これらの依存関係に関する詳細とリポジトリへのリンクについては、Infinispan ドキュメントを参照してください。

Keycloak に依存関係を提供するには、それぞれの JAR を `providers` ディレクトリに配置し、次のコマンドを入力して Keycloak をビルドします。

```
bin/kc.[sh|bat] build --cache-stack=<ec2|google|azure>
```

**カスタムトランスポートスタック**

利用可能なトランスポートスタックが展開に適していない場合は、キャッシュ設定ファイルを編集して独自のトランスポートスタックを定義できます。

詳細については、インライン JGroups スタックの使用を参照してください。

カスタムトランスポートスタックの定義

```xml
<jgroups>
<stack name="my-encrypt-udp" extends="udp">
<SSL_KEY_EXCHANGE keystore_name="server.jks"
keystore_password="password"
stack.combine="INSERT_AFTER"
stack.position="VERIFY_SUSPECT2"/>
<ASYM_ENCRYPT asym_keylength="2048"
asym_algorithm="RSA"
change_key_on_coord_leave = "false"
change_key_on_leave = "false"
use_external_key_exchange = "true"
stack.combine="INSERT_BEFORE"
stack.position="pbcast.NAKACK2"/>
</stack>
</jgroups>

<cache-container name="keycloak">
<transport lock-timeout="60000" stack="my-encrypt-udp"/>
...
</cache-container>
```

デフォルトでは、`cache-stack` オプションに設定された値は、キャッシュ設定ファイルで定義したトランスポートスタックよりも優先されます。カスタムスタックを定義する場合は、カスタム変更を有効にするために `cache-stack` オプションを使用しないようにしてください。

### キャッシュ通信のセキュリティ保護

現在の Infinispan キャッシュ実装は、RBAC、ACL、トランスポートスタック暗号化などのさまざまなセキュリティ対策によって保護される必要があります。

JGroups は、Keycloak サーバー間のすべての通信を処理し、TCP 通信用の Java SSL ソケットをサポートしています。Keycloak は、カスタム JGroups スタックを作成したり、キャッシュ XML ファイルを変更したりせずに、TLS 通信を設定するための CLI オプションを使用します。

TLS を有効にするには、`cache-embedded-mtls-enabled` を `true` に設定する必要があります。これには、使用する証明書を含むキーストアが必要です。`cache-embedded-mtls-key-store-file` はキーストアへのパスを設定し、`cache-embedded-mtls-key-store-password` はキーストアの復号化パスワードを設定します。トラストストアには、接続を受け入れる有効な証明書が含まれ、`cache-embedded-mtls-trust-store-file` (トラストストアへのパス) と `cache-embedded-mtls-trust-store-password` (トラストストアの復号化パスワード) で設定できます。不正なアクセスを制限するには、各 Keycloak 展開に対して自己署名証明書を使用します。

UDP または TCP_NIO2 を使用する JGroups スタックについては、JGroups 暗号化ドキュメントでプロトコルスタックの設定方法を参照してください。

キャッシュ通信のセキュリティ保護の詳細については、Infinispan セキュリティガイドを参照してください。

### キャッシュからのメトリックの公開

キャッシュからのメトリックは、メトリックが有効になっていると自動的に公開されます。

キャッシュメトリックのヒストグラムを有効にするには、`cache-metrics-histograms-enabled` を `true` に設定します。これらのメトリックは、レイテンシ分布に関するより詳細な情報を提供しますが、これらのメトリックを収集するとパフォーマンスに影響を与える可能性があるため、すでに負荷の高いシステムでは注意して有効にする必要があります。

```
bin/kc.[sh|bat] start --metrics-enabled true --cache-metrics-histograms-enabled true
```

メトリックを有効にする方法の詳細については、Keycloak メトリックの有効化を参照してください。

### 関連するオプション

| オプション | 値 |
|---|---|
| cache | ispn (デフォルト), local |
| cache-config-file | キャッシュ構成をロードするファイル |
| cache-embedded-mtls-enabled | Keycloak サーバー間のネットワーク通信を暗号化する | true, false (デフォルト) |
| cache-embedded-mtls-key-store-file | キーストアファイルのパス |
| cache-embedded-mtls-key-store-password | キーストアにアクセスするためのパスワード |
| cache-embedded-mtls-trust-store-file | トラストストアファイルのパス |
| cache-embedded-mtls-trust-store-password | トラストストアにアクセスするためのパスワード |
| cache-metrics-histograms-enabled | 組み込みキャッシュのメトリックのヒストグラムを有効にする | メトリックが有効な場合のみ使用可能 | true, false (デフォルト) |
| cache-remote-host | リモートストア構成のリモートサーバーのホスト名 |
| cache-remote-password | リモートストアのリモートサーバーへの認証のパスワード | リモートホストが設定されている場合のみ使用可能 |
| cache-remote-port | リモートストア構成のリモートサーバーのポート | リモートホストが設定されている場合のみ使用可能 | 11222 (デフォルト) |
| cache-remote-tls-enabled | セキュリティで保護されたリモート Infinispan サーバーとの通信に TLS サポートを有効にする | リモートホストが設定されている場合のみ使用可能 | true (デフォルト), false |
| cache-remote-username | リモートストアのリモートサーバーへの認証のユーザー名 | リモートホストが設定されている場合のみ使用可能 |
| cache-stack | クラスタ通信とノード検出に使用するデフォルトのスタックを定義する |

### まとめ

このドキュメントは、Keycloak で分散キャッシュを使用する方法について説明しました。分散キャッシュは、Keycloak の高可用性とマルチノードクラスタ設定を実現する上で重要な要素です。適切なキャッシュ設定を選択し、セキュリティを確保することで、Keycloak のパフォーマンスと信頼性を向上させることができます。
