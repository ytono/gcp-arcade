## 添付ファイルの説明資料

**資料名**: Multi-site deployments

**概要**: この資料は、Keycloakのマルチサイト展開における、高可用性（HA）を実現するためのアーキテクチャ、構成要素、運用手順について解説しています。特に、**アクティブ-パッシブ展開**に焦点を当て、データベースレプリケーション、Infinispanキャッシュレプリケーション、ロードバランサーを用いたフェールオーバーやスイッチオーバーなどの詳細な手順を説明しています。

**主な内容**:

**1. はじめに**:
- マルチサイト展開によって、Keycloakの可用性を向上させることができます。
- Infinispanキャッシュを用いて、複数のKeycloakインスタンスを相互接続することで、負荷分散とフェールオーバーを可能にします。

**2. 概念と構成要素**:
- アクティブ-パッシブ展開の概念
- データベース接続プールの概念
- スレッドプールの概念
- CPUとメモリのリソースサイズに関する概念
- Infinispan CLIコマンドを自動化する概念

**3. 構成要素の青写真**:
- AWS Auroraを複数の可用性ゾーンに展開
- Keycloak Operatorを使用したHA Keycloakの展開
- Infinispan Operatorを使用したHA Infinispanの展開
- Keycloakを外部Infinispanに接続
- AWS Route 53ロードバランサーの展開
- AWS Route 53フェールオーバーラムダの展開

**4. 運用手順**:
- **セカンダリサイトへのフェールオーバー**: ロードバランサーによる自動フェールオーバーと、手動フェールオーバーの手順
- **セカンダリサイトへのスイッチオーバー**: プライマリサイトを一時的にオフラインにするための手順
- **同期されていないパッシブサイトからの回復**: Infinispanキャッシュが同期されていない場合の回復手順
- **プライマリサイトへの復帰**: セカンダリサイトからプライマリサイトへの復帰手順

**5. アクティブ-パッシブ展開の概念**:
- 同期レプリケーションによるアクティブ-パッシブ展開の理解
- この設定を使用する際の利点と欠点

**6. データベースとキャッシュ**:
- 2つの独立したKeycloak展開を低レイテンシーネットワークで接続する
- ユーザー、レルム、クライアント、オフラインセッションなどのデータを、両方のサイトに同期レプリケートされたデータベースに保存する
- データをKeycloakのInfinispanキャッシュと外部Infinispanにキャッシュする
- InfinispanのCross-DC機能を活用

**7. データ損失の要因**:
- サイト間のネットワーク障害やコンポーネント障害は、短いサービスダウンタイムにつながる可能性があります。
- 通信障害が発生すると、手動操作でシステムを再同期する必要があります。

**8. 設定上の制限事項**:
- アップグレード: バージョンアップグレード（メジャー、マイナー、パッチ）を行うと、オフラインセッション以外のすべてのセッションデータが失われます。
- フェールオーバー: 成功したフェールオーバーには、過去の障害によるシステムの劣化がない状態が必要です。
- スイッチオーバー: 成功したスイッチオーバーには、過去の障害によるシステムの劣化がない状態が必要です。
- 同期されていないサイト: 同期Infinispan要求が失敗すると、サイトが同期しなくなる可能性があります。

**9. 質問と回答**:
- 同期データベースレプリケーションの理由
- 同期Infinispanレプリケーションの理由
- 低レイテンシーネットワークが必要な理由
- アクティブ-パッシブの理由
- この設定は2つのサイトに限定されるか？
- 同期クラスタは非同期クラスタよりも安定性に劣るか？

**10. アクティブ-パッシブ展開の構成要素**:
- アクティブ-パッシブ展開を設定するために必要な構成要素のリスト
- 各構成要素の青写真へのリンク

**11. 構成要素の詳細**:
- 2つのサイトを低レイテンシー接続で接続する
- KeycloakとInfinispanのための環境
- 同期レプリケートされたデータベース（AWS Auroraを使用）
- Cross-DC機能を持つInfinispan
- それぞれのサイトにクラスタ化されたKeycloak展開（外部Infinispanに接続）
- Keycloak展開の健康状態をチェックするロードバランサー（AWS Route 53を使用）

**資料の活用**:
- Keycloakのマルチサイト展開を検討しているインフラエンジニア向けに、構成要素、アーキテクチャ、運用手順に関する情報提供
- Blueprintsを参考に、実際の環境に適した設定を作成可能
- アクティブ-パッシブ展開におけるリスクと利点を理解し、システムの可用性を向上させる

**補足**:
- 本資料は、あくまでも一例であり、具体的な環境や要件に合わせて適宜変更する必要があります。
- KeycloakやInfinispanの最新バージョンでは、さらに機能が追加されている可能性があります。最新のドキュメントを参照してください。
